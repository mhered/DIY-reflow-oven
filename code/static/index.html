<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Temperature Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <script>
    let interval = null;

    function updateTemp() {
      fetch('/temperature')
        .then(res => res.json())
        .then(data => {
          document.getElementById("currentTemp").innerText = data.temp + " Â°C";
          
          // Update current target display (separate from user input)
          document.getElementById("currentTarget").innerText = data.target + " Â°C";
          
          // Update temperature limits for user input box
          const targetInput = document.getElementById("targetInput");
          if (data.limits) {
            targetInput.min = data.limits.min;
            targetInput.max = data.limits.max;
          }

          const heaterIcon = document.getElementById("heaterStatus");
          if (data.heater_on) {
            heaterIcon.style.display = "inline";
          } else {
            heaterIcon.style.display = "none";
          }
        })
        .catch(error => {
          console.error('Error fetching temperature:', error);
          document.getElementById("currentTemp").innerText = "Error";
          document.getElementById("currentTarget").innerText = "Error";
        });
    }

    function setTarget() {
      const targetInput = document.getElementById("targetInput");
      const val = targetInput.value;
      
      // Validate input
      if (!val || val.trim() === '') {
        showFeedback('Please enter a target temperature', 'error');
        return;
      }
      
      fetch('/set_target?value=' + val)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'ok') {
            console.log('Target set to:', data.target);
            showFeedback('Target set to ' + data.target + 'Â°C', 'success');
            targetInput.value = '';
          } else {
            console.error('Error setting target:', data.message || 'Unknown error');
            showFeedback(data.message || 'Error setting target temperature', 'error');
          }
        })
        .catch(error => {
          console.error('Error setting target:', error);
          showFeedback('Network error setting target temperature', 'error');
        });
    }

    function showFeedback(message, type) {
      // Create or update feedback element
      let feedback = document.getElementById("feedback");
      if (!feedback) {
        feedback = document.createElement("div");
        feedback.id = "feedback";
        feedback.style.cssText = `
          margin: 10px 0;
          padding: 10px;
          border-radius: 4px;
          text-align: center;
          font-weight: bold;
        `;
        document.querySelector(".container").appendChild(feedback);
      }
      
      feedback.textContent = message;
      feedback.className = type; // 'success' or 'error'
      
      if (type === 'success') {
        feedback.style.backgroundColor = '#d4edda';
        feedback.style.color = '#155724';
        feedback.style.border = '1px solid #c3e6cb';
      } else {
        feedback.style.backgroundColor = '#f8d7da';
        feedback.style.color = '#721c24';
        feedback.style.border = '1px solid #f5c6cb';
      }
      
      // Clear feedback after 3 seconds
      setTimeout(() => {
        feedback.textContent = '';
        feedback.style.display = 'none';
      }, 3000);
      
      feedback.style.display = 'block';
    }

    window.onload = () => {
      updateTemp();
      interval = setInterval(updateTemp, 2000);
    };
  </script>
</head>

<body>
  <div class="container">
    <h1>Temperature</h1>
  
    <div class="temperature">
      <div class="temp-wrapper">
        <span id="currentTemp">--</span>
        <span id="heaterStatus">ğŸ”¥</span>
      </div>
    </div>

    <div class="target-display">
      <label>Current Target: <span id="currentTarget">--</span></label>
    </div>

    <div class="input-group">
      <input type="number" id="targetInput" placeholder="Enter temperature (Â°C)">
      <button onclick="setTarget()">Set Target</button>
    </div>
  </div>
</body>

</html>